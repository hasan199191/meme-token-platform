"use strict";var e=require("@walletconnect/client"),t=require("algosdk"),n=require("bowser");function o(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var i=o(e),a=o(t),r=o(n);function s(e,t,n,o){return new(n||(n=Promise))((function(i,a){function r(e){try{l(o.next(e))}catch(e){a(e)}}function s(e){try{l(o.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,s)}l((o=o.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;class l extends Error{constructor(e,t,...n){super(...n),Error.captureStackTrace&&Error.captureStackTrace(this,l),this.name="PeraWalletConnectError",this.data=e,this.message=t}}const c=new class{constructor(e){this.listener=void 0,this.channel=e.channel}setupListener({onReceiveMessage:e}){this.close(),this.listener=t=>{if("object"==typeof t.data)try{t.data.channel===this.channel&&e(t)}catch(e){console.error(e)}},window.addEventListener("message",this.listener)}sendMessage({message:e,targetWindow:t,origin:n,timeout:o=1e3}){setTimeout((()=>{const o={channel:this.channel,message:e};t.postMessage(o,{targetOrigin:n||"*"})}),o)}close(){this.listener&&(window.removeEventListener("message",this.listener),this.listener=void 0)}}({channel:"pera-web-wallet"}),d=700,u=50;function h(){const e=document.querySelector('meta[name="name"]'),t=document.querySelector('meta[name="description"]');let{title:n}=document,o="";return e instanceof HTMLMetaElement&&(n=e.content),t instanceof HTMLMetaElement&&(o=t.content),{title:n,description:o,url:window.location.origin,favicon:g()[0]}}function g(){const e=document.getElementsByTagName("link"),t=[];for(let n=0;n<e.length;n++){const o=e[n],i=o.getAttribute("rel");if(i&&i.toLowerCase().indexOf("icon")>-1){const e=o.getAttribute("href");if(e&&-1===e.toLowerCase().indexOf("https:")&&-1===e.toLowerCase().indexOf("http:")&&0!==e.indexOf("//")){let n=`${window.location.protocol}//${window.location.host}`;if(0===e.indexOf("/"))n+=e;else{const t=window.location.pathname.split("/");t.pop();n+=`${t.join("/")}/${e}`}t.push(n)}else if(0===(null==e?void 0:e.indexOf("//"))){const n=window.location.protocol+e;t.push(n)}else e&&t.push(e)}}return t}function p(e){return new Promise(((t,n)=>{try{const o=window.open(e,"_blank");let i=0;const a=setInterval((()=>{if(i+=1,i===u)return clearInterval(a),void n(new l({type:"MESSAGE_NOT_RECEIVED"},"Couldn't open Pera Wallet, please try again."));o&&(!0===o.closed&&(clearInterval(a),n(new l({type:"OPERATION_CANCELLED"},"Operation cancelled by user"))),c.sendMessage({message:{type:"TAB_OPEN"},origin:e,targetWindow:o}))}),d);c.setupListener({onReceiveMessage:e=>{"TAB_OPEN_RECEIVED"===e.data.message.type&&(clearInterval(a),t(o))}})}catch(e){n(e)}}))}const w="pera-wallet-connect-modal-wrapper",m="pera-wallet-redirect-modal-wrapper",v="pera-wallet-sign-txn-toast-wrapper",f="pera-wallet-modal";function b(e){const t=document.createElement("div");return t.setAttribute("id",e),document.body.appendChild(t),t}function A(){b(m).innerHTML="<pera-wallet-redirect-modal></pera-wallet-redirect-modal>"}function T(){b(v).innerHTML="<pera-wallet-sign-txn-toast></pera-wallet-sign-txn-toast>"}function N(e){const t=document.getElementById(e);t&&t.remove()}const y={WALLET:"PeraWallet.Wallet",WALLETCONNECT:"walletconnect"};function E(){return"undefined"==typeof localStorage?void 0:localStorage}function S(e,t){var n;null===(n=E())||void 0===n||n.setItem(y.WALLET,JSON.stringify({type:t||"pera-wallet",accounts:e,selectedAccount:e[0]}))}function _(){var e;const t=null===(e=E())||void 0===e?void 0:e.getItem(y.WALLET);return t?JSON.parse(t):null}function C(){return new Promise(((e,t)=>{var n,o;try{null===(n=E())||void 0===n||n.removeItem(y.WALLETCONNECT),null===(o=E())||void 0===o||o.removeItem(y.WALLET),e(void 0)}catch(e){t(e)}}))}function L(e){const t=e.slice();for(let e=t.length-1;e>0;e--){const n=Math.floor(Math.random()*(e+1));[t[e],t[n]]=[t[n],t[e]]}return t}const W="https://wc.perawallet.app/config.json";function I(){return function(e,t={}){return fetch(e,t).then((e=>e.json())).then((e=>e))}(W,{cache:"no-store"})}function O(){return s(this,void 0,void 0,(function*(){let e={bridgeURL:"",webWalletURL:"",isWebWalletAvailable:!1,shouldDisplayNewBadge:!1,shouldUseSound:!0,silent:!1,promoteMobile:!1};try{const t=yield I();void 0!==t.web_wallet&&t.web_wallet_url&&(e.isWebWalletAvailable=t.web_wallet),void 0!==t.display_new_badge&&(e.shouldDisplayNewBadge=t.display_new_badge),void 0!==t.use_sound&&(e.shouldUseSound=t.use_sound),void 0!==t.silent&&(e.silent=t.silent),void 0!==t.promote_mobile&&(e.promoteMobile=t.promote_mobile),e=Object.assign(Object.assign({},e),{bridgeURL:L(t.servers||[])[0]||"",webWalletURL:t.web_wallet_url||""})}catch(e){console.log(e)}return e}))}function M(e){return Uint8Array.from(window.atob(e),(e=>e.charCodeAt(0)))}function R(e,t){return{id:Date.now()*Math.pow(10,3)+Math.floor(Math.random()*Math.pow(10,3)),jsonrpc:"2.0",method:e,params:t}}function P(){return"undefined"!=typeof navigator}function D(){return P()&&/Android/i.test(navigator.userAgent)}function x(){return P()&&/iPhone|iPod|Android/i.test(navigator.userAgent)}const B=D()?"algorand://":"perawallet-wc://";function U(e){return{ROOT:`https://${e}`,CONNECT:`https://${e}/connect`,TRANSACTION_SIGN:`https://${e}/transaction/sign`}}function j({method:e,signTxnRequestParams:t,signer:n,chainId:o,webWalletURL:i,resolve:a,reject:r}){const d=U(i);!function(){s(this,void 0,void 0,(function*(){try{const i=yield p(d.TRANSACTION_SIGN);if(i){let a;"SIGN_TXN"===e?a={type:"SIGN_TXN",txn:t}:"SIGN_DATA"===e&&n&&o&&(a={type:"SIGN_DATA",data:t,signer:n,chainId:o}),a&&c.sendMessage({message:a,origin:d.TRANSACTION_SIGN,targetWindow:i})}const s=setInterval((()=>{!0===(null==i?void 0:i.closed)&&(r(new l({type:`${e}_CANCELLED`},"Transaction signing is cancelled by user.")),clearInterval(s))}),2e3);c.setupListener({onReceiveMessage:t=>function({event:e,newPeraWalletTab:t,method:n,resolve:o,reject:i}){switch(e.data.message.type){case"SIGN_TXN_CALLBACK":null==t||t.close(),o(e.data.message.signedTxns.map((e=>M(e.signedTxn))));break;case"SIGN_DATA_CALLBACK":null==t||t.close(),o(e.data.message.signedData.map((e=>M(e.signedData))));break;case"SIGN_TXN_NETWORK_MISMATCH":i(new l({type:`${n}_NETWORK_MISMATCH`,detail:e.data.message.error},e.data.message.error||"Network mismatch"));break;case"SIGN_TXN_CALLBACK_ERROR":null==t||t.close(),i(new l({type:`${n}_CANCELLED`},e.data.message.error));break;case"SESSION_DISCONNECTED":null==t||t.close(),C(),i(new l({type:"SESSION_DISCONNECTED",detail:e.data.message.error},e.data.message.error))}}({event:t,newPeraWalletTab:i,method:e,resolve:a,reject:r})})}catch(e){r(e)}}))}()}function k({webWalletURL:e,chainId:t,resolve:n,reject:o}){const i=U(e);return function(){return s(this,void 0,void 0,(function*(){try{const e=yield p(i.CONNECT);e&&c.sendMessage({message:{type:"CONNECT",data:Object.assign(Object.assign({},h()),{chainId:t})},origin:i.CONNECT,targetWindow:e});const r=setInterval((()=>{!0===(null==e?void 0:e.closed)&&(o(new l({type:"CONNECT_CANCELLED"},"Connect is cancelled by user")),clearInterval(r),a())}),2e3);c.setupListener({onReceiveMessage:t=>function({event:e,newPeraWalletTab:t,resolve:n,reject:o}){if(n&&"CONNECT_CALLBACK"===e.data.message.type){const o=e.data.message.data.addresses;S(o,"pera-wallet-web"),n(o),N(w),null==t||t.close()}else"CONNECT_NETWORK_MISMATCH"===e.data.message.type&&(o(new l({type:"CONNECT_NETWORK_MISMATCH",detail:e.data.message.error},e.data.message.error||"Your wallet is connected to a different network to this dApp. Update your wallet to the correct network (MainNet or TestNet) to continue.")),N(w),null==t||t.close())}({event:t,newPeraWalletTab:e,resolve:n,reject:o})})}catch(e){a(),o(e)}}))};function a(){N(w)}}function G({isWebWalletAvailable:e,shouldDisplayNewBadge:t,shouldUseSound:n,compactMode:o,promoteMobile:i,singleAccount:a,selectedAccount:r}){return{open:(s={isWebWalletAvailable:e,shouldDisplayNewBadge:t,shouldUseSound:n,compactMode:o,promoteMobile:i,singleAccount:a,selectedAccount:r},e=>{if(!document.getElementById(w)){const t=b(w),n=`${e}&algorand=true`,{isWebWalletAvailable:o,shouldDisplayNewBadge:i,shouldUseSound:a,compactMode:r,promoteMobile:l,singleAccount:c,selectedAccount:d}=s;t.innerHTML=`<pera-wallet-connect-modal uri="${n}" is-web-wallet-avaliable="${o}" should-display-new-badge="${i}" should-use-sound="${a}" compact-mode="${r}" promote-mobile="${l}" single-account="${c}" selected-account="${d||""}"></pera-wallet-connect-modal>`}}),close:()=>N(w)};var s}"undefined"!=typeof window&&(window.global=window,window.Buffer=window.Buffer||require("buffer").Buffer,Promise.resolve().then((function(){return require("./App-3aac5bb0.js")}))),exports.PERA_DOWNLOAD_URL="https://perawallet.app/download/",exports.PERA_WALLET_APP_DEEP_LINK=B,exports.PERA_WALLET_CONNECT_MODAL_ID=w,exports.PERA_WALLET_MODAL_CLASSNAME=f,exports.PERA_WALLET_REDIRECT_MODAL_ID=m,exports.PERA_WALLET_SIGN_TXN_MODAL_ID="pera-wallet-sign-txn-modal-wrapper",exports.PERA_WALLET_SIGN_TXN_TOAST_ID=v,exports.PeraWalletConnect=class{constructor(e){this.bridge=(null==e?void 0:e.bridge)||"",this.connector=null,this.shouldShowSignTxnToast=void 0===(null==e?void 0:e.shouldShowSignTxnToast)||e.shouldShowSignTxnToast,this.chainId=null==e?void 0:e.chainId,this.compactMode=(null==e?void 0:e.compactMode)||!1,this.singleAccount=(null==e?void 0:e.singleAccount)||!1}get platform(){return function(){const e=_();let t=null;return"pera-wallet"===(null==e?void 0:e.type)?t="mobile":"pera-wallet-web"===(null==e?void 0:e.type)&&(t="web"),t}()}get isConnected(){var e;return"mobile"===this.platform?!!this.connector:"web"===this.platform&&!!(null===(e=_())||void 0===e?void 0:e.accounts.length)}get isPeraDiscoverBrowser(){return this.checkIsPeraDiscoverBrowser()}connect(e){return new Promise(((t,n)=>s(this,void 0,void 0,(function*(){var o;try{if(null===(o=this.connector)||void 0===o?void 0:o.connected)try{yield this.connector.killSession()}catch(e){}const{isWebWalletAvailable:a,bridgeURL:r,webWalletURL:s,shouldDisplayNewBadge:c,shouldUseSound:d,promoteMobile:u}=yield O(),h=k({resolve:t,reject:n,webWalletURL:s,chainId:this.chainId,isCompactMode:this.compactMode});a&&(window.onWebWalletConnect=h),this.connector=new i.default({bridge:this.bridge||r||"https://bridge.walletconnect.org",qrcodeModal:G({isWebWalletAvailable:a,shouldDisplayNewBadge:c,shouldUseSound:d,compactMode:this.compactMode,promoteMobile:u,singleAccount:this.singleAccount,selectedAccount:null==e?void 0:e.selectedAccount})}),yield this.connector.createSession({chainId:this.chainId||4160}),function(e,t){var n,o,i,a;const r=document.getElementById(e),s=null===(o=null===(n=null==r?void 0:r.querySelector(e.replace("-wrapper","")))||void 0===n?void 0:n.shadowRoot)||void 0===o?void 0:o.querySelector(`.${f}`),l=null===(a=null===(i=null==s?void 0:s.querySelector("pera-wallet-modal-header"))||void 0===i?void 0:i.shadowRoot)||void 0===a?void 0:a.getElementById("pera-wallet-modal-header-close-button");null==l||l.addEventListener("click",(()=>{t(),N(e)}))}(w,(()=>n(new l({type:"CONNECT_MODAL_CLOSED"},"Connect modal is closed by user")))),this.connector.on("connect",((e,o)=>{var i,a;e&&n(e),t((null===(i=this.connector)||void 0===i?void 0:i.accounts)||[]),S((null===(a=this.connector)||void 0===a?void 0:a.accounts)||[])}))}catch(e){console.log(e),n(new l({type:"SESSION_CONNECT",detail:e},e.message||"There was an error while connecting to Pera Wallet"))}}))))}reconnectSession(){return new Promise(((e,t)=>s(this,void 0,void 0,(function*(){var n,o;try{const a=_();if(!a)return void e([]);if("pera-wallet-web"===(null==a?void 0:a.type)){const{isWebWalletAvailable:n}=yield O();n?e(a.accounts||[]):t(new l({type:"SESSION_RECONNECT",detail:"Pera Web is not available"},"Pera Web is not available"))}this.connector&&e(this.connector.accounts||[]),this.bridge=(null===(n=function(){var e;const t=null===(e=E())||void 0===e?void 0:e.getItem(y.WALLETCONNECT);return t?JSON.parse(t):null}())||void 0===n?void 0:n.bridge)||"",this.bridge&&(this.connector=new i.default({bridge:this.bridge}),e((null===(o=this.connector)||void 0===o?void 0:o.accounts)||[])),this.isConnected||e([])}catch(e){yield this.disconnect(),t(new l({type:"SESSION_RECONNECT",detail:e},e.message||"There was an error while reconnecting to Pera Wallet"))}}))))}disconnect(){var e;return s(this,void 0,void 0,(function*(){let t;this.isConnected&&"mobile"===this.platform&&(t=null===(e=this.connector)||void 0===e?void 0:e.killSession(),null==t||t.then((()=>{this.connector=null}))),yield C()}))}signTransactionWithMobile(e){return s(this,void 0,void 0,(function*(){const t=R("algo_signTxn",[e]);try{try{const{silent:e}=yield O(),n=(yield this.connector.sendCustomRequest(t,{forcePushNotification:!e})).filter(Boolean);return"string"==typeof n[0]?n.map(M):n.map((e=>Uint8Array.from(e)))}catch(e){return yield Promise.reject(new l({type:"SIGN_TRANSACTIONS",detail:e},e.message||"Failed to sign transaction"))}}finally{N(m),N(v)}}))}signTransactionWithWeb(e,t){return new Promise(((n,o)=>j({signTxnRequestParams:e,webWalletURL:t,method:"SIGN_TXN",resolve:n,reject:o})))}signDataWithMobile({data:e,signer:t,chainId:n}){return s(this,void 0,void 0,(function*(){const o=R("algo_signData",e.map((e=>Object.assign(Object.assign({},e),{signer:t,chainId:n}))));try{try{const{silent:e}=yield O(),t=(yield this.connector.sendCustomRequest(o,{forcePushNotification:!e})).filter(Boolean);return"string"==typeof t[0]?t.map(M):t.map((e=>Uint8Array.from(e)))}catch(e){return yield Promise.reject(new l({type:"SIGN_TRANSACTIONS",detail:e},e.message||"Failed to sign transaction"))}}finally{N(m),N(v)}}))}signDataWithWeb({data:e,signer:t,chainId:n,webWalletURL:o}){return new Promise(((i,a)=>j({method:"SIGN_DATA",signTxnRequestParams:e,signer:t,chainId:n,webWalletURL:o,resolve:i,reject:a})))}checkIsPeraDiscoverBrowser(){return window.navigator.userAgent.includes("pera")}signTransaction(e,t){return s(this,void 0,void 0,(function*(){if("mobile"===this.platform&&(x()?A():!x()&&this.shouldShowSignTxnToast&&T(),!this.connector))throw new Error("PeraWalletConnect was not initialized correctly.");const n=e.flatMap((e=>e.map((e=>function(e,t){let n;t&&!(e.signers||[]).includes(t)&&(n=[]);const o={txn:(i=e.txn,Buffer.from(a.default.encodeUnsignedTransaction(i)).toString("base64"))};var i;return Array.isArray(n)&&(o.signers=n),e.authAddr&&(o.authAddr=e.authAddr),e.message&&(o.message=e.message),e.msig&&(o.msig=e.msig),o}(e,t)))));if("web"===this.platform){const{webWalletURL:e}=yield O();return this.signTransactionWithWeb(n,e)}return this.signTransactionWithMobile(n)}))}signData(e,t){return s(this,void 0,void 0,(function*(){const n=this.chainId||4160;if("mobile"===this.platform&&(x()?A():!x()&&this.shouldShowSignTxnToast&&T(),!this.connector))throw new Error("PeraWalletConnect was not initialized correctly.");if("web"===this.platform){const{webWalletURL:o}=yield O();return this.signDataWithWeb({data:e,signer:t,chainId:n,webWalletURL:o})}const o=e.map((e=>Object.assign(Object.assign({},e),{data:Buffer.from(e.data).toString("base64")})));return this.signDataWithMobile({data:o,signer:t,chainId:n})}))}},exports.closePeraWalletSignTxnToast=function(){N(v)},exports.detectBrowser=function(){if(!P())return null;const{userAgent:e}=navigator;let t;return t=e.match(/DuckDuckGo/i)?"DuckDuckGo":e.match(/OPX/i)?"Opera GX":navigator.brave?"Brave":r.default.getParser(navigator.userAgent).getBrowserName(),t},exports.isAndroid=D,exports.isIOS=function(){return P()&&/iPhone|iPad|iPod/i.test(navigator.userAgent)},exports.isMobile=x,exports.removeModalWrapperFromDOM=N;
